---
# indentations are critical in YAML headers, be careful when editing this section

title: "Ecosystem Protection Level" 
subtitle: "Estuarine Realm" 

title-block-banner: "#028A85" #Background colour of the title block: Apply component colours where necessary - find hex codes in _brand.yml
title-block-banner-color: white # Header text colour: DO NOT CHANGE

# List authors here in the order you want them displayed in the title block
# See examples in README
author:
  # Copy this block and add details for each author of your page. Make sure you maintain indentations exactly as they are here
author:
  - name:
      given: Lara
      family: van Niekerk
    orcid: 0000-0001-5761-1337 
    affiliations:
      - ref: csir1
      - ref: nmu1
  - name:
      given: Andrew L.
      family: Skowno 
    orcid: 0000-0000-0000-0000 
    affiliations:
      - ref: sanbi1 
  - name:
      given: Kerry 
      family: Sink 
    orcid: 0000-0001-5051-573X 
    affiliations:
      - ref: sanbi1 
      - ref: nmu1
   - name:
      given: Linda R.
      family: Harris 
    orcid: 0000-0000-0000-0000  
    affiliations:
      - ref: nmu1     

affiliations:
  - id: csir1
    number: 1
    name: Council for Scientific and Industrial Research (CSIR), Stellenbosch,South Africa   
  - id: nmu1
    number: 2
    name: Institute for Coastal and Marine Research (CMR), Nelson Mandela University,Gqeberha, South Africa 
  - id: sanbi1
    number: 3
    name: South African National Biodiversity Institute (SANBI)
   

# This date determines the PUBLISHED date in the title block
date: last-modified

# Remember to rename the default .bib file and change the name here
bibliography: est_references.bib

# This section sets up the page citation format. DO NOT EDIT
citation:
  type: webpage
  container-title: National Biodiversity Assessment 2025
  publisher: South African National Biodiversity Institute
  url: http://nba.sanbi.org.za/
# Do not edit or change any of the following entries
appendix-cite-as: false
google-scholar: true
---

------------------------------------------------------------------------

<!--# Key statistics section: This section can be edited to report more/fewer statistics by adding more items to each column (these will be stacked), or adding more columns (then they will be placed next to each other). Using source view, copy and paste the entire block (the three lines with the pipe | at the start), and edit contents as necessary. Be careful to apply the correct styling parameters (the bits in the sqiggly brackets {}). If you are adding or removing columns, remember to adjust the column widths to add up to 100%. Preferably add more rows, as more than two columns tend to display poorly on narrow screens. Delete the entire section (plus the horizontal line above the Summary header) if you don't want to include statistics on your page-->

::::: columns
::: {.column width="50%"}
<center>

| [20%]{.inline-style-well-protected}
| of 163 ecosystem types
| [Well Protected]{.inline-style-indicator}

| [34%]{.inline-style-well-protected}
| of 163 ecosystem types
| [Poorly Protected]{.inline-style-indicator}

</center>
:::

::: {.column width="50%"}
<center>

| [29%]{.inline-style-well-protected}
| of 163 ecosystem types
| [Moderately Protected]{.inline-style-indicator}

| [17%]{.inline-style-well-protected}
| of 163 ecosystem types
| [Not Protected]{.inline-style-indicator}

</center>
:::
:::::

------------------------------------------------------------------------

## Approach {#summary}

The protection level assessment for marine ecosystems was adjusted to align with global targets. While the 2018 assessment used a standard 20% target with an addition rule applied, the 2025 assessment applied a 30% target: In order for a marine ecosystem type to qualify in the Well Protected category, at least 30% of the ecosystem type (i.e. the ecosystem target) needs to be in a natural / near natural ecological condition. If this rule was not met, the ecosystem was categorised as Moderately Protected. Additionally, any area inside an MPA that was in degraded condition had it's contribution to the protection level target scaled according to the severity of the degradation.

In 2018, South Africa had 25 coastal Marine Protected Areas (MPAs) covering less than 0.6% of the ocean around South Africa (6 260 km2), up from 0.4% (4 711 km2) in 2011. The MPA estate increased significantly between 2018 and 2019 and now covers 5.4% of the ocean around South Africa (51 477 km2). No further progress in MPA establishment has been made since 2019. The total number of MPAs in South Africa increased to 42 (Figure 65).

```{r}
#| label: fig-mpa_map
#| fig-cap: South Africa's Marine Protected Area network.
#| echo: false
#| message: false
#| warning: false
#| out-width: 100%

# library(tidyverse)
# library(nbaR)
# library(sf)

# #add MPA and eez data 
# ## mpa
# mpa <- st_read(list.files(path="data",
#                           pattern="^SANBI_PA_2023Q4_July2024.shp$",
#                           recursive = T,
#                           full.names = T)[1],
#   quiet = TRUE) # SANBI_PA_2023Q4_July2024.shp
# 
# 
# ##eez
# eez <- st_read(list.files(path="data", 
#                              pattern="^eez_MEM2018.gpkg$", 
#                              recursive = T, 
#                              full.names = T)[1],
#   quiet = TRUE)
# 
# 
# ## remove multi-surface variable, if needed
# mpa <- st_zm(mpa, drop=TRUE, what = "ZM")
# 
# ##take only the marine and combine zones so one row per mpa
# mpa <- mpa %>%
#    filter(TYPEv2 == "Marine Protected Area") %>% # all protected areas needed to cover the shore ecosystem types that are protected by some terrestrial protected areas
#   group_by(CUR_NME) %>%
#   summarize(geometry = st_union(geometry))%>%
#   filter(CUR_NME != "Prince Edward Island Marine Protected Area")
# 
# ggplot()+
#   geom_sf(data = mpa, fill = "#028A85")+
#   geom_sf(data = eez, fill = NA)+
#     ggplot2::theme(legend.position = "none",plot.background = ggplot2::element_blank(),
#                    panel.background = ggplot2::element_blank(),
#                    panel.border = ggplot2::element_blank(),
#                    axis.text = ggplot2::element_blank(),
#                    axis.ticks = ggplot2::element_blank())

knitr::include_graphics("imgs/mpa_map.png")

```

## Ecosystem Protection Level Assessment

Of the 70 ecosystem types that were previously Not Protected, 58 received their first protection, including 7 of 13 pelagic ecosystem types. In 2019, an additional x (used to be 17) ecosystem types have advanced to Well Protected with a total of 20% of ecosystem types now falling within this category. There is an opportunity to improve the protection level of some of the Poorly or Moderately Protected ecosystem types to Well Protected through ecosystem restoration and strengthened MPA management to reduce ecosystem degradation.

## Benthic ecosystem protection level

<!-- it is important to use second-level headings in panel tabsets, i.e. two hashes -->

```{r}
#| label: fig-epl_map_benthic
#| fig-cap: Benthic marine ecosystem type protection level.
#| echo: false
#| message: false
#| warning: false
#| out-width: 100%

# library(tidyverse)
# library(nbaR)
# library(sf)

# #marine linewidth
# m_lwd = 0.001
# 
# dat <-  st_read(
#     dir("data",
#         "marine_ecosystems.gpkg",
#         full.names = T,
#         recursive = T)[1],
#   quiet = TRUE)
# 
# marine_benth <- dat %>%
#   group_by(ecosystem_type, ecosystem_functional_type_getl3, threat_status, protection_level) %>% #
#   summarise(geometry = st_union(geom)) %>%
#   st_cast(to = "MULTIPOLYGON") %>%
#   filter(ecosystem_functional_type_getl3 !="Pelagic ocean waters")%>% 
#   st_transform(crs = 4326)
# 
# marine_pel <- dat %>%
#   group_by(ecosystem_type, ecosystem_functional_type_getl3, threat_status, protection_level) %>% #
#   summarise(geometry = st_union(geom)) %>%
#   st_cast(to = "MULTIPOLYGON") %>%
#   filter(ecosystem_functional_type_getl3 =="Pelagic ocean waters")%>% 
#   st_transform(crs = 4326)
# 
# pro_level <- nbaR::nba_map(marine_benth,
#                            "vector",
#                            FILL = protection_level, 
#                         LEGEND = T)+
# #  geom_sf(data=marine_benth, colour = "black", fill = NA, lwd = m_lwd) + #add ecosystem outlines for marine
#   #geom_sf(data=eez, colour = "black", fill = NA, lwd = t_lwd) + #add province outlines
#   theme(plot.margin=grid::unit(c(0,0,0,0), "pt")) +  #remove white space around the plot
#   coord_sf(expand = FALSE)
# 
# #ggsave(plot = pro_level, filename = "imgs/epl_benth.jpg")
# 
# ## add the donut plot
# epl_donut <- marine_benth %>% 
#   st_drop_geometry() %>% 
#   ungroup() %>% 
#   count(protection_level) %>% 
#   tidyr::pivot_wider(names_from = protection_level, values_from = n) %>% 
#   mutate(EPL = "EPL") %>% 
#     select(EPL, `Well Protected`, `Moderately Protected`, `Poorly Protected`, `Not Protected`) %>% 
#   nbaR::nba_plot(GROUPS = EPL, 
#                  COLS = 2:5, 
#                  CHRT = "donut",
#                  NUM = TRUE, 
#                  LAB = "", 
#                  GRP = F) +
#   theme(legend.position = "none") 
# 
# pro_level + 
#   annotation_custom(ggplotGrob(epl_donut),
#                               xmin=18, ymin=-33, xmax=29, ymax=-27)

knitr::include_graphics("imgs/epl_benthic_with_donut.png")

```

## Pelagic ecosystem protection level

<!-- it is important to use second-level headings in panel tabsets, i.e. two hashes -->

```{r}
#| label: fig-epl_map_pelagic
#| fig-cap: Pelagic marine ecosystem type protection level.
#| echo: false
#| out-width: 100%

# pro_level <- nbaR::nba_map(marine_pel,
#                            "vector",
#                            FILL = protection_level, 
#                         LEGEND = T)+
# #  geom_sf(data=marine_pel, colour = "black", fill = NA, lwd = m_lwd) + #add ecosystem outlines for marine
#   #geom_sf(data=eez, colour = "black", fill = NA, lwd = t_lwd) + #add province outlines
#   theme(plot.margin=grid::unit(c(0,0,0,0), "pt")) +  #remove white space around the plot
#   coord_sf(expand = FALSE)    # <-- prevents padding around data
# # theme_void()
# 
# #ggsave(plot = pro_level, filename = "imgs/epl_pel.jpg")
# 
# ## add the donut plot
# epl_donut <- marine_pel %>% 
#   st_drop_geometry() %>% 
#   ungroup() %>% 
#   count(protection_level) %>% 
#   tidyr::pivot_wider(names_from = protection_level, values_from = n) %>% 
#   mutate(EPL = "EPL") %>% 
#     select(EPL, `Well Protected`, `Poorly Protected`, `Not Protected`) %>% 
#   nbaR::nba_plot(GROUPS = EPL, 
#                  COLS = 2:4, 
#                  CHRT = "donut",
#                  NUM = TRUE, 
#                  LAB = "", 
#                  GRP = F) +
#   theme(legend.position = "none") 
# 
# pro_level + 
#   annotation_custom(ggplotGrob(epl_donut),
#                               xmin=18, ymin=-33, xmax=29, ymax=-27)

knitr::include_graphics("imgs/epl_pelagic_with_donut.png")

```

```{r}
#| label: fig-epl_bargraphs
#| echo: false
#| fig-cap: Protection level of marine ecosystem types by functional group. a) represents the number of ecosystem types and b) the extent of ecosystem types in each protection category.

library(tidyverse)
library(nbaR)
library(sf)

# ecosystem_summary <- dat %>%
#      st_drop_geometry() %>%
#       group_by(ecosystem_functional_type_getl3, protection_level) %>%
#       summarise(count = n(),
#                 extent = sum(eco_extent_km2)) %>% 
#   mutate(ecosystem_functional_type_getl3 = str_replace_all(ecosystem_functional_type_getl3,"Mesophotic and sub-photic rocky shelves", "rocky shelves"))
# 
# count <- ecosystem_summary %>%
#       pivot_wider(
#         id_cols = ecosystem_functional_type_getl3,
#         names_from = protection_level,
#         values_from = count) %>%
#       mutate(across(where(is.numeric), ~replace_na(.x,0))) %>% ungroup()
# 
# extent <- ecosystem_summary %>%
#       pivot_wider(
#         id_cols = ecosystem_functional_type_getl3,
#         names_from = protection_level,
#         values_from = extent) %>%
#       mutate(across(where(is.numeric), ~replace_na(.x,0))) %>% ungroup()
# 
# # ets <- count %>% 
# #   mutate(metric = "count") %>% 
# #   bind_rows(extent %>% mutate(metric = "extent"))
# 
# 
# epl_combined <- count %>%
# mutate(metric = "count") %>%
# bind_rows(extent %>%
# mutate(metric = "extent"))
# 

# load the data 
epl_combined <- read.csv(file=list.files(path = paste0(here::here(), "/quarto/data"), pattern = "^epl_combined_count_extent.csv$", recursive = TRUE, full.names = TRUE), 
                    stringsAsFactors = FALSE, check.names = FALSE)

# Combined EPL plot
epl_combined_plot <- nba_plot_comb(epl_combined,
                                   ecosystem_functional_type_getl3,
                                   METRIC_COL = metric,
                                   METRICS = c("count", "extent"),
                                   2:5,
                                   CHRT = "bar",
                                   NUM = FALSE,
                                   LAB = "Percentage of ecosystem",
                                   SAVE = NULL)

epl_combined_plot

```

Additional offshore MPAs will need to be established to represent ecosystem types that are Not Protected or to advance Poorly Protected ecosystem types towards Well Protected. Ecosystem types in the Natal-Delagoa ecoregion are the best protected of the shelf ecoregions and ecosystem types in the Southern Benguela are less protected. Protection in the deep ocean beyond the shelf edge is less than on continental shelves, but the deep benthic and pelagic ecosystems are also less threatened

Offshore ecosystem types are still less represented in South Africa’s MPA network than shore and shelf ecosystem types. Slopes, abyssal plains, muddy and rocky shelves are the most poorly protected ecosystem functional groups. Unless these functional groups are targeted for inclusion in MPAs or OECMs, gaps in representation will persist. Increasing extent of protection alone will not advance marine ecosystems to well protected. The condition of marine ecosystems in MPAs needs improvement.

There is progress in evaluating the ecological, socio-economic and governance effectiveness of South Africa’s MPAs, which reveal gaps in connectivity, participation, cultural heritage protection and governance limiting progress in protection. It is increasingly evident that MPAs won't work if they don’t consider and involve people and address issues that undermine their legitimacy and effectiveness. Other Effective Conservation Measures offer new opportunities for a broader diversify of conservation models to contribute to marine protection.

```{r}
#| label: tbl-epl
#| tbl-cap: "Protection level and threat status of marine ecosystem types in South Africa."

# library(here)
#library(gt)
library(reactable)
library(dplyr)

# marine_ecotype <-  st_read(
#     dir("data",
#         "marine_ecosystems.gpkg",
#         full.names = T,
#         recursive = T)[1],
#   quiet = TRUE) %>% 
#   st_drop_geometry() 
# 
# marine_ecotype <- marine_ecotype %>%  
#   select(c(bathome_getl2, ecosystem_type, protection_level, threat_status)) %>% 
#   mutate(protection_level = factor(protection_level, levels = c("Well Protected",
#                                  "Moderately Protected",
#                                  "Poorly Protected",
#                                  "Not Protected"),
#                       ordered = TRUE)) %>%
#   rename(Bathome = bathome_getl2, 
#          `Ecosystem type` = ecosystem_type,
#          `Threat status` = threat_status, 
#          `Protection level` = protection_level) %>% 
#   arrange(Bathome, `Ecosystem type`,`Protection level`, `Threat status`) 
# 

# load data
epl <- read.csv(file=list.files(path = paste0(here::here(), "/quarto/data"), pattern = "^epl_ets_ecotypes.csv$", recursive = TRUE, full.names = TRUE), 
                    stringsAsFactors = FALSE, check.names = FALSE) %>% 
  select(-'Threat status', -'Threat basis') # removing the threat status, assuming we only want to show that in the ETS page?

# create the table
reactable(
  epl,
  filterable = TRUE,
  searchable = FALSE,
  pagination = FALSE,
  height = 600,
  defaultColDef = colDef(
    headerStyle = list(background = "#02268A", color = "white", fontWeight = "bold")
  ),
  theme = reactableTheme(
    inputStyle = list(
      color = "black", # create black searching text in the filter box, otherwise one doesn't see it!
      backgroundColor = "white",
      border = "1px solid #ccc"
    )))

```

## Technical documentation

<!--# This section is compulsory for all scientific content, but what you include here is flexible based on what you have available for your indicators -->

<!--# the below examples/recommendations can be modified, e.g. you could do a technical report PDF, as long as it is made available on a public repository (figshare?) and can be linked to in this document -->

<!--# avoid linking to Google Drive or other personal drives that may not be permanent. -->

<!--# Always use DOI to link to published papers - never use the journal's website -->

### GitLab repositories

-   **Protection level assessment**: [gitlab.com/nba_2025/ecosystem_assessment/protection_level](https://gitlab.com/nba_2025/ecosystem_assessment/protection_level)

### Key Publications

## Recommended citation

```{r}
#| output: asis
#| label: lst-citation-code

library(nbaR) 
library(knitr)
library(rmarkdown)

# Code for fetching the yaml metadata
# Note that this only runs when the .qmd file is rendered, therefore the outputs of this code block will return no results if you try to run it within R - that does not mean it is not working

meta <- knitr::opts_knit$get("rmarkdown.pandoc.to")  # forces knitr to load metadata
meta <- rmarkdown::metadata  # full YAML is now in `meta`

nba_citation(meta)

```

::::::: {#refs}
---
# indentations are critical in YAML headers, be careful when editing this section

title: "Ecosystem Protection Level" # Compulsory
subtitle: "Estuarine Realm" # Optional: delete if you are not using a subtitle

title-block-banner: "#028A85" #Background colour of the title block: Apply component colours where necessary - find hex codes in _brand.yml
title-block-banner-color: white # Header text colour: DO NOT CHANGE

# List authors here in the order you want them displayed in the title block
# See examples in README
author:
  # Copy this block and add details for each author of your page. Make sure you maintain indentations exactly as they are here
  - name:
      given: Kerry #Add author's first name here. Abbreviate the middle name
      family: sink #Add author's surname here
    orcid: 0000-0001-5051-573X # Author's orcid ID. Delete this line if author is not on orcid
    affiliations:
      - ref: sanbi1 # Ref here must match the id of one of the affiliations listed below
      # If an author has more than one affiliation, add more - ref: lines here

affiliations:
# List affiliations here and number them in the order that they are associated with the list of authors above. If multiple authors have the same affiliation, only list the affiliation once here.
# Write out institutional names in full
# See README for common examples - they can be copied and pasted here
# Make sure you maintain indentations exactly as they are here
  - id: sanbi1 # Use this as the affiliation ref with authors above
    number: 1 # This number is used to associate authors with affiliations
    name: South African National Biodiversity Institute

# This date determines the PUBLISHED date in the title block
date: last-modified

# Remember to rename the default .bib file and change the name here
bibliography: marine_references.bib

# This section sets up the page citation format. DO NOT EDIT
citation:
  type: webpage
  container-title: National Biodiversity Assessment 2025
  publisher: South African National Biodiversity Institute
  url: http://nba.sanbi.org.za/
# Do not edit or change any of the following entries
appendix-cite-as: false
google-scholar: true
---

------------------------------------------------------------------------

<!--# Key statistics section: This section can be edited to report more/fewer statistics by adding more items to each column (these will be stacked), or adding more columns (then they will be placed next to each other). Using source view, copy and paste the entire block (the three lines with the pipe | at the start), and edit contents as necessary. Be careful to apply the correct styling parameters (the bits in the sqiggly brackets {}). If you are adding or removing columns, remember to adjust the column widths to add up to 100%. Preferably add more rows, as more than two columns tend to display poorly on narrow screens. Delete the entire section (plus the horizontal line above the Summary header) if you don't want to include statistics on your page-->

::::: columns
::: {.column width="50%"}
<center>

| [20%]{.inline-style-well-protected}
| of 163 ecosystem types
| [Well Protected]{.inline-style-indicator}

| [34%]{.inline-style-well-protected}
| of 163 ecosystem types
| [Poorly Protected]{.inline-style-indicator}

</center>
:::

::: {.column width="50%"}
<center>

| [29%]{.inline-style-well-protected}
| of 163 ecosystem types
| [Moderately Protected]{.inline-style-indicator}

| [17%]{.inline-style-well-protected}
| of 163 ecosystem types
| [Not Protected]{.inline-style-indicator}

</center>
:::
:::::

------------------------------------------------------------------------

## Approach

The protection level assessment for marine ecosystems was adjusted to align with global targets. While the 2018 assessment used a standard 20% target with an addition rule applied, the 2025 assessment applied a 30% target: In order for a marine ecosystem type to qualify in the Well Protected category, at least 30% of the ecosystem type (i.e. the ecosystem target) needs to be in a natural / near natural ecological condition. If this rule was not met, the ecosystem was categorised as Moderately Protected. Additionally, any area inside an MPA that was in degraded condition had it's contribution to the protection level target scaled according to the severity of the degradation.

In 2018, South Africa had 25 coastal Marine Protected Areas (MPAs) covering less than 0.6% of the ocean around South Africa (6 260 km2), up from 0.4% (4 711 km2) in 2011. The MPA estate increased significantly between 2018 and 2019 and now covers 5.4% of the ocean around South Africa (51 477 km2). No further progress in MPA establishment has been made since 2019. The total number of MPAs in South Africa increased to 42 (Figure 65).

```{r}
#| label: fig-mpa_map
#| fig-cap: South Africa's Marine Protected Area network.
#| echo: false
#| message: false
#| warning: false
#| out-width: 100%

# library(tidyverse)
# library(nbaR)
# library(sf)

# #add MPA and eez data 
# ## mpa
# mpa <- st_read(list.files(path="data",
#                           pattern="^SANBI_PA_2023Q4_July2024.shp$",
#                           recursive = T,
#                           full.names = T)[1],
#   quiet = TRUE) # SANBI_PA_2023Q4_July2024.shp
# 
# 
# ##eez
# eez <- st_read(list.files(path="data", 
#                              pattern="^eez_MEM2018.gpkg$", 
#                              recursive = T, 
#                              full.names = T)[1],
#   quiet = TRUE)
# 
# 
# ## remove multi-surface variable, if needed
# mpa <- st_zm(mpa, drop=TRUE, what = "ZM")
# 
# ##take only the marine and combine zones so one row per mpa
# mpa <- mpa %>%
#    filter(TYPEv2 == "Marine Protected Area") %>% # all protected areas needed to cover the shore ecosystem types that are protected by some terrestrial protected areas
#   group_by(CUR_NME) %>%
#   summarize(geometry = st_union(geometry))%>%
#   filter(CUR_NME != "Prince Edward Island Marine Protected Area")
# 
# ggplot()+
#   geom_sf(data = mpa, fill = "#02268A")+
#   geom_sf(data = eez, fill = NA)+
#     ggplot2::theme(legend.position = "none",plot.background = ggplot2::element_blank(),
#                    panel.background = ggplot2::element_blank(),
#                    panel.border = ggplot2::element_blank(),
#                    axis.text = ggplot2::element_blank(),
#                    axis.ticks = ggplot2::element_blank())

knitr::include_graphics("imgs/mpa_map.png")

```

## Ecosystem Protection Level Assessment

Of the 70 ecosystem types that were previously Not Protected, 58 received their first protection, including 7 of 13 pelagic ecosystem types. In 2019, an additional x (used to be 17) ecosystem types have advanced to Well Protected with a total of 20% of ecosystem types now falling within this category. There is an opportunity to improve the protection level of some of the Poorly or Moderately Protected ecosystem types to Well Protected through ecosystem restoration and strengthened MPA management to reduce ecosystem degradation.

## Benthic ecosystem protection level

<!-- it is important to use second-level headings in panel tabsets, i.e. two hashes -->

```{r}
#| label: fig-epl_map_benthic
#| fig-cap: Benthic marine ecosystem type protection level.
#| echo: false
#| message: false
#| warning: false
#| out-width: 100%

# library(tidyverse)
# library(nbaR)
# library(sf)

# #marine linewidth
# m_lwd = 0.001
# 
# dat <-  st_read(
#     dir("data",
#         "marine_ecosystems.gpkg",
#         full.names = T,
#         recursive = T)[1],
#   quiet = TRUE)
# 
# marine_benth <- dat %>%
#   group_by(ecosystem_type, ecosystem_functional_type_getl3, threat_status, protection_level) %>% #
#   summarise(geometry = st_union(geom)) %>%
#   st_cast(to = "MULTIPOLYGON") %>%
#   filter(ecosystem_functional_type_getl3 !="Pelagic ocean waters")%>% 
#   st_transform(crs = 4326)
# 
# marine_pel <- dat %>%
#   group_by(ecosystem_type, ecosystem_functional_type_getl3, threat_status, protection_level) %>% #
#   summarise(geometry = st_union(geom)) %>%
#   st_cast(to = "MULTIPOLYGON") %>%
#   filter(ecosystem_functional_type_getl3 =="Pelagic ocean waters")%>% 
#   st_transform(crs = 4326)
# 
# pro_level <- nbaR::nba_map(marine_benth,
#                            "vector",
#                            FILL = protection_level, 
#                         LEGEND = T)+
# #  geom_sf(data=marine_benth, colour = "black", fill = NA, lwd = m_lwd) + #add ecosystem outlines for marine
#   #geom_sf(data=eez, colour = "black", fill = NA, lwd = t_lwd) + #add province outlines
#   theme(plot.margin=grid::unit(c(0,0,0,0), "pt")) +  #remove white space around the plot
#   coord_sf(expand = FALSE)
# 
# #ggsave(plot = pro_level, filename = "imgs/epl_benth.jpg")
# 
# ## add the donut plot
# epl_donut <- marine_benth %>% 
#   st_drop_geometry() %>% 
#   ungroup() %>% 
#   count(protection_level) %>% 
#   tidyr::pivot_wider(names_from = protection_level, values_from = n) %>% 
#   mutate(EPL = "EPL") %>% 
#     select(EPL, `Well Protected`, `Moderately Protected`, `Poorly Protected`, `Not Protected`) %>% 
#   nbaR::nba_plot(GROUPS = EPL, 
#                  COLS = 2:5, 
#                  CHRT = "donut",
#                  NUM = TRUE, 
#                  LAB = "", 
#                  GRP = F) +
#   theme(legend.position = "none") 
# 
# pro_level + 
#   annotation_custom(ggplotGrob(epl_donut),
#                               xmin=18, ymin=-33, xmax=29, ymax=-27)

knitr::include_graphics("imgs/epl_benthic_with_donut.png")

```

## Pelagic ecosystem protection level

<!-- it is important to use second-level headings in panel tabsets, i.e. two hashes -->

```{r}
#| label: fig-epl_map_pelagic
#| fig-cap: Pelagic marine ecosystem type protection level.
#| echo: false
#| out-width: 100%

# pro_level <- nbaR::nba_map(marine_pel,
#                            "vector",
#                            FILL = protection_level, 
#                         LEGEND = T)+
# #  geom_sf(data=marine_pel, colour = "black", fill = NA, lwd = m_lwd) + #add ecosystem outlines for marine
#   #geom_sf(data=eez, colour = "black", fill = NA, lwd = t_lwd) + #add province outlines
#   theme(plot.margin=grid::unit(c(0,0,0,0), "pt")) +  #remove white space around the plot
#   coord_sf(expand = FALSE)    # <-- prevents padding around data
# # theme_void()
# 
# #ggsave(plot = pro_level, filename = "imgs/epl_pel.jpg")
# 
# ## add the donut plot
# epl_donut <- marine_pel %>% 
#   st_drop_geometry() %>% 
#   ungroup() %>% 
#   count(protection_level) %>% 
#   tidyr::pivot_wider(names_from = protection_level, values_from = n) %>% 
#   mutate(EPL = "EPL") %>% 
#     select(EPL, `Well Protected`, `Poorly Protected`, `Not Protected`) %>% 
#   nbaR::nba_plot(GROUPS = EPL, 
#                  COLS = 2:4, 
#                  CHRT = "donut",
#                  NUM = TRUE, 
#                  LAB = "", 
#                  GRP = F) +
#   theme(legend.position = "none") 
# 
# pro_level + 
#   annotation_custom(ggplotGrob(epl_donut),
#                               xmin=18, ymin=-33, xmax=29, ymax=-27)

knitr::include_graphics("imgs/epl_pelagic_with_donut.png")

```

```{r}
#| label: fig-epl_bargraphs
#| echo: false
#| fig-cap: Protection level of marine ecosystem types by functional group. a) represents the number of ecosystem types and b) the extent of ecosystem types in each protection category.

library(tidyverse)
library(nbaR)
library(sf)

# ecosystem_summary <- dat %>%
#      st_drop_geometry() %>%
#       group_by(ecosystem_functional_type_getl3, protection_level) %>%
#       summarise(count = n(),
#                 extent = sum(eco_extent_km2)) %>% 
#   mutate(ecosystem_functional_type_getl3 = str_replace_all(ecosystem_functional_type_getl3,"Mesophotic and sub-photic rocky shelves", "rocky shelves"))
# 
# count <- ecosystem_summary %>%
#       pivot_wider(
#         id_cols = ecosystem_functional_type_getl3,
#         names_from = protection_level,
#         values_from = count) %>%
#       mutate(across(where(is.numeric), ~replace_na(.x,0))) %>% ungroup()
# 
# extent <- ecosystem_summary %>%
#       pivot_wider(
#         id_cols = ecosystem_functional_type_getl3,
#         names_from = protection_level,
#         values_from = extent) %>%
#       mutate(across(where(is.numeric), ~replace_na(.x,0))) %>% ungroup()
# 
# # ets <- count %>% 
# #   mutate(metric = "count") %>% 
# #   bind_rows(extent %>% mutate(metric = "extent"))
# 
# 
# epl_combined <- count %>%
# mutate(metric = "count") %>%
# bind_rows(extent %>%
# mutate(metric = "extent"))
# 

# load the data 
epl_combined <- read.csv(file=list.files(path = paste0(here::here(), "/quarto/data"), pattern = "^epl_combined_count_extent.csv$", recursive = TRUE, full.names = TRUE), 
                    stringsAsFactors = FALSE, check.names = FALSE)

# Combined EPL plot
epl_combined_plot <- nba_plot_comb(epl_combined,
                                   ecosystem_functional_type_getl3,
                                   METRIC_COL = metric,
                                   METRICS = c("count", "extent"),
                                   2:5,
                                   CHRT = "bar",
                                   NUM = FALSE,
                                   LAB = "Percentage of ecosystem",
                                   SAVE = NULL)

epl_combined_plot

```

Additional offshore MPAs will need to be established to represent ecosystem types that are Not Protected or to advance Poorly Protected ecosystem types towards Well Protected. Ecosystem types in the Natal-Delagoa ecoregion are the best protected of the shelf ecoregions and ecosystem types in the Southern Benguela are less protected. Protection in the deep ocean beyond the shelf edge is less than on continental shelves, but the deep benthic and pelagic ecosystems are also less threatened

Offshore ecosystem types are still less represented in South Africa’s MPA network than shore and shelf ecosystem types. Slopes, abyssal plains, muddy and rocky shelves are the most poorly protected ecosystem functional groups. Unless these functional groups are targeted for inclusion in MPAs or OECMs, gaps in representation will persist. Increasing extent of protection alone will not advance marine ecosystems to well protected. The condition of marine ecosystems in MPAs needs improvement.

There is progress in evaluating the ecological, socio-economic and governance effectiveness of South Africa’s MPAs, which reveal gaps in connectivity, participation, cultural heritage protection and governance limiting progress in protection. It is increasingly evident that MPAs won't work if they don’t consider and involve people and address issues that undermine their legitimacy and effectiveness. Other Effective Conservation Measures offer new opportunities for a broader diversify of conservation models to contribute to marine protection.

```{r}
#| label: tbl-epl
#| tbl-cap: "Protection level and threat status of marine ecosystem types in South Africa."

# library(here)
#library(gt)
library(reactable)
library(dplyr)

# marine_ecotype <-  st_read(
#     dir("data",
#         "marine_ecosystems.gpkg",
#         full.names = T,
#         recursive = T)[1],
#   quiet = TRUE) %>% 
#   st_drop_geometry() 
# 
# marine_ecotype <- marine_ecotype %>%  
#   select(c(bathome_getl2, ecosystem_type, protection_level, threat_status)) %>% 
#   mutate(protection_level = factor(protection_level, levels = c("Well Protected",
#                                  "Moderately Protected",
#                                  "Poorly Protected",
#                                  "Not Protected"),
#                       ordered = TRUE)) %>%
#   rename(Bathome = bathome_getl2, 
#          `Ecosystem type` = ecosystem_type,
#          `Threat status` = threat_status, 
#          `Protection level` = protection_level) %>% 
#   arrange(Bathome, `Ecosystem type`,`Protection level`, `Threat status`) 
# 

# load data
epl <- read.csv(file=list.files(path = paste0(here::here(), "/quarto/data"), pattern = "^epl_ets_ecotypes.csv$", recursive = TRUE, full.names = TRUE), 
                    stringsAsFactors = FALSE, check.names = FALSE) %>% 
  select(-'Threat status', -'Threat basis') # removing the threat status, assuming we only want to show that in the ETS page?

# create the table
reactable(
  epl,
  filterable = TRUE,
  searchable = FALSE,
  pagination = FALSE,
  height = 600,
  defaultColDef = colDef(
    headerStyle = list(background = "#028A85", color = "white", fontWeight = "bold")
  ),
  theme = reactableTheme(
    inputStyle = list(
      color = "black", # create black searching text in the filter box, otherwise one doesn't see it!
      backgroundColor = "white",
      border = "1px solid #ccc"
    )))

```

## Technical documentation

<!--# This section is compulsory for all scientific content, but what you include here is flexible based on what you have available for your indicators -->

<!--# the below examples/recommendations can be modified, e.g. you could do a technical report PDF, as long as it is made available on a public repository (figshare?) and can be linked to in this document -->

<!--# avoid linking to Google Drive or other personal drives that may not be permanent. -->

<!--# Always use DOI to link to published papers - never use the journal's website -->

### GitLab repositories

-   **Protection level assessment**: [gitlab.com/nba_2025/ecosystem_assessment/protection_level](https://gitlab.com/nba_2025/ecosystem_assessment/protection_level)

### Key Publications

## Recommended citation

```{r}
#| output: asis
#| label: lst-citation-code

library(nbaR) 
library(knitr)
library(rmarkdown)

# Code for fetching the yaml metadata
# Note that this only runs when the .qmd file is rendered, therefore the outputs of this code block will return no results if you try to run it within R - that does not mean it is not working

meta <- knitr::opts_knit$get("rmarkdown.pandoc.to")  # forces knitr to load metadata
meta <- rmarkdown::metadata  # full YAML is now in `meta`

nba_citation(meta)

```

<div>

</div>
:::::::
