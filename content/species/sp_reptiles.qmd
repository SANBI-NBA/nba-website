---
# indentations are critical in YAML headers, be careful when editing this section

title: "Reptiles" # Compulsory
subtitle: "" # Optional: delete if you are not using a subtitle

title-block-banner: "#De2104" #Background colour of the title block: Apply component colours where necessary - find hex codes in _brand.yml
title-block-banner-color: white # Header text colour: DO NOT CHANGE

# List authors here in the order you want them displayed in the title block
# See examples in README
author:
  # Copy this block and add details for each author of your page. Make sure you maintain indentations exactly as they are here
  - name:
      given: First #Add author's first name here. Abbreviate the middle name
      family: Author #Add author's surname here
    orcid: 0000-0000-0000-0000 # Author's orcid ID. Delete this line if author is not on orcid
    affiliations:
      - ref: af1 # Ref here must match the id of one of the affiliations listed below
      # If an author has more than one affiliation, add more - ref: lines here

affiliations:
# List affiliations here and number them in the order that they are associated with the list of authors above. If multiple authors have the same affiliation, only list the affiliation once here.
# Write out institutional names in full
# See README for common examples - they can be copied and pasted here
# Make sure you maintain indentations exactly as they are here
  - id: af1 # Use this as the affiliation ref with authors above
    number: 1 # This number is used to associate authors with affiliations
    name: Name of Affiliation

# This date determines the PUBLISHED date in the title block
date: last-modified

# Remember to rename the default .bib file and change the name here
bibliography: species.bib

# This section sets up the page citation format. DO NOT EDIT
citation:
  type: webpage
  container-title: National Biodiversity Assessment 2025
  publisher: South African National Biodiversity Institute
  url: http://nba.sanbi.org.za/
# Do not edit or change any of the following entries
appendix-cite-as: false
google-scholar: true
---

------------------------------------------------------------------------

::::::: columns
::: {.column width="25%"}
<center>

| [00%]{.inline-style-threatened}
| taxa assessed
| [Threatened]{.inline-style-indicator}

</center>
:::

::: {.column width="25%"}
<center>

| [00%]{.inline-style-well-protected}
| taxa assessed
| [Well Protected]{.inline-style-indicator}

</center>
:::

::: {.column width="25%"}
<center>

| [00%]{.inline-style-not-protected}
| taxa assessed
| [Not protected]{.inline-style-indicator}

</center>
:::

::: {.column width="25%"}
```{r}
#| label: fig-0
#| fig-cap: "*add image*"
#knitr::include_graphics("")
```
:::
:::::::

------------------------------------------------------------------------

## Key findings

::::: columns
::: {.column width="50%"}
-   

-   

-   
:::

::: {.column width="50%"}
```{r}
#| label: fig-1
#| fig-cap: "Species richness map..."
#knitr::include_graphics("")
```
:::
:::::

### Threat status, trends and pressures

1.  ***Threat status***

add text

:::: panel-tabset
## Figure

<!-- it is important to use second-level headings in panel tabsets, i.e. two hashes -->

```{r}
#| label: fig-2
#| fig-cap: "Threat status of South African ... " 
#| out-width: 100%
#| out-height: "auto"

library(dplyr)
library(tidyr)
library(nbaR)
library(readxl)
library(patchwork)
library(ggplot2)
library(grid)

# ---- Dataset ----
df <- read_excel("data/2025_Overall_status_summary.xlsx", 
                 sheet = "Summary")

# ---- Function ----

# Collapse rare categories into "Rare"
prep_taxon_data <- function(df, taxon) {
  df_overall <- df %>%
    filter(`Taxonomic grouping` == taxon,
           !Status %in% c("NA", "NE")) %>%
    mutate(Status = ifelse(Status %in% c("Rare", "Critically Rare", "Extremely Rare"), 
                           "Rare", Status))
  
  df_endemic <- df %>%
    filter(`Taxonomic grouping` == taxon,
           Endemism == "Endemic",
           !Status %in% c("NA", "NE")) %>%
    mutate(Status = ifelse(Status %in% c("Rare", "Critically Rare", "Extremely Rare"), 
                           "Rare", Status))
  
# Convert to wide with consistent threat columns
  
make_wide <- function(dat, type_name) {
    dat %>%
      group_by(`Taxonomic grouping`, Status) %>%
      summarise(Count = n(), .groups = "drop") %>%
      pivot_wider(names_from = Status, values_from = Count, values_fill = 0) %>%
      mutate(Type = type_name) %>%
      select(Type, everything())
  }
  
df_combined <- bind_rows(make_wide(df_overall, "Overall"),
                           make_wide(df_endemic, "Endemic"))
  
  list(
    combined = df_combined,
    dat_overall = df_combined %>% filter(Type == "Overall"),
    dat_endemic = df_combined %>% filter(Type == "Endemic")
  )
}

# Add total number to donut hole
add_total <- function(plot, total, SCALE_TEXT = 1) {
  plot + annotate("text",
                  x = 2, y = 0,
                  label = total,
                  size = 3.5 * SCALE_TEXT,
                  fontface = "bold")
}

# Change name of taxon according to the webpage
taxon_data <- prep_taxon_data(df, "Reptiles")
dat1 <- taxon_data$dat_overall
dat2 <- taxon_data$dat_endemic

total_overall <- sum(rowSums(dat1[, 3:ncol(dat1)], na.rm = TRUE))
total_endemic <- sum(rowSums(dat2[, 3:ncol(dat2)], na.rm = TRUE))

# Define your lookup for threat abbreviations → full names
threat_lookup <- c(
  "CR" = "Critically Endangered",
  "CR (PE)" = "Critically Endangered, Possibly Extinct",
  "EN" = "Endangered",
  "VU" = "Vulnerable",
  "NT" = "Near Threatened",
  "LC" = "Least Concern",
  "DD" = "Data Deficient",
  "NE" = "Not Evaluated",
  "EX" = "Extinct",
  "RE" = "Regionally Extinct",
  "Rare" = "Rare"
)

# Rename threat status to full text
dat1 <- dat1 %>%
  rename_with(~ ifelse(.x %in% names(threat_lookup),
                       threat_lookup[.x],
                       .x))

dat2 <- dat2 %>%
  rename_with(~ ifelse(.x %in% names(threat_lookup),
                       threat_lookup[.x],
                       .x))


# ---- Plot -----
plot1 <- nba_plot(dat1, biome, 3:ncol(dat1),
                  CHRT = "donut", NUM = FALSE, LAB = "A. Overall") %>%
  add_total(total_overall)

plot2 <- nba_plot(dat2, biome, 3:ncol(dat2),
                  CHRT = "donut", NUM = FALSE, LAB = "B. Endemic") +
  xlim(c(2, 4.5))   # shrink the donut
plot2 <- add_total(plot2, total_endemic)



# Combine your plots (as before)
combined_donut_plot <- plot1 + plot2 +
  plot_layout(guides = "collect") &
  theme(
    legend.position = "bottom",
    legend.justification = "center"
  ) &
  guides(fill = guide_legend(ncol = 3))
combined_donut_plot

```

## Data

<!--# If the table is long use the div to give it a vertical scroll bar. Otherwise the div can be excluded. -->

::: {#table .table style="height:500px;overflow-y: auto"}
```{r}
#| label: tbl-tab-0
#| tbl-cap: "Plant threat status." 
#| classes: plain

library(dplyr)
library(nbaR)
library(gt)

threat_lookup_rev <- c(
  "Critically Endangered" = "CR",
  "Critically Endangered, Possibly Extinct" = "CR (PE)",
  "Endangered" = "EN",
  "Vulnerable" = "VU",
  "Near Threatened" = "NT",
  "Least Concern" = "LC",
  "Data Deficient" = "DD",
  "Not Evaluated" = "NE",
  "Extinct" = "EX",
  "Regionally Extinct" = "RE",
  "Rare" = "Rare"
)

# Apply to both datasets
dat1 <- dat1 %>%
  rename_with(~ ifelse(.x %in% names(threat_lookup_rev),
                       threat_lookup_rev[.x],
                       .x))

dat2 <- dat2 %>%
  rename_with(~ ifelse(.x %in% names(threat_lookup_rev),
                       threat_lookup_rev[.x],
                       .x))
# First, select only the columns we want and rename Type → Taxon
dat1_sel <- dat1 %>% select(1, 3:ncol(dat1)) %>% rename(Taxon = Type)
dat2_sel <- dat2 %>% select(1, 3:ncol(dat2)) %>% rename(Taxon = Type)

# Now assign custom row names (or first column values)
dat1_sel$Taxon <- "Overall reptiles"
dat2_sel$Taxon <- "Endemic reptiles"

# Combine into one table
dat_combined_final <- bind_rows(dat1_sel, dat2_sel)

dat_combined_final <- dat_combined_final %>%
  rowwise() %>%
  mutate(Total = sum(c_across(where(is.numeric)), na.rm = TRUE)) %>%
  ungroup() 

gt(dat_combined_final) %>% nba_tbl_theme()
```
:::
::::

2.  ***Trends (RLI)***

add text

```{r}
#| label: fig-3
#| fig-cap: "The Red List Index (RLI) for ..."

#knitr::include_graphics("imgs/RLIbiomes 1.png")
```

```{r}
#| label: fig-4
#| fig-cap: "The distribution of ... "

#knitr::include_graphics("imgs/Plant_heatmap.png")
```

::: {#box-1 .callout-note .species title="Box 1. Species box" collapse="true"}
## Box 1. Title

add text

remove the syntax "<!-- -->" for inserting the images replace existing with appropriate images for current page <!-- ![](imgs/Fig%201.jpg){fig-alt="box_1_fig_1" width="45%"}--> <!-- ![](imgs/Figure%202.jpg){fig-alt="box_1_fig_2" width="45%"}-->
:::

3.  ***Pressures***

add text

```{r}
#| label: fig-5
#| fig-cap: "Key pressures on South Africa’s ... "
#| out.width: 100%


#knitr::include_graphics("imgs/Plant_OA.svg")
```

:::::: {#box-2 .callout-note .species title="Box 2. Species box" collapse="true"}
## Box 2. Title

::::: columns
::: {.column width="100%"}
Add text

remove the syntax "<!-- -->" for inserting the images replace existing with appropriate images for current page <!--![](imgs/Euphorbias%20received.jpg){fig-alt="box_2_fig_2" width="45%"} ![](imgs/fd44b009-60e2.jpg){fig-alt="box_2_fig_1" width="45%"}

![](imgs/1000067813.jpg){fig-alt="box_2_fig_1" width="45%"} ![](imgs/20221203_074211.jpg){fig-alt="box_2_fig_1" width="45%"} -->
:::

::: {.column width="25%"}
:::
:::::
::::::

## Protection level

### Main findings

Add text

```{r}
#| label: fig-6
#| fig-cap: "" 

library(dplyr)
library(tidyr)
library(nbaR)
library(readxl)
library(patchwork)

dat1 <- read_excel("data/NBA_example_pro_data.xlsx", 
    sheet = "2025")
dat2 <- read_excel("data/NBA_example_pro_data.xlsx", 
    sheet = "2025_en")

dat1 <- dat1 %>% filter(dat1$`Taxon groups` == "Reptiles")
dat2 <- dat2 %>% filter(dat2$`Taxon groups` == "Reptiles")
plot1 <- nba_plot(dat1,
                  biome,
                  2:5,
                  CHRT = "donut",
                  NUM = FALSE,
                  LAB = "A. Overall",
                  SAVE = NULL)  # return ggplot object

plot2 <- nba_plot(dat2,
                  biome,
                  2:5,
                  CHRT = "donut",
                  NUM = FALSE,
                  LAB = "B. Endemic",
                  SAVE = NULL)  # return ggplot object

# Combine and put shared legend at bottom center
combined_plot <- plot1 + plot2 +
  patchwork::plot_layout(guides = "collect") & 
  ggplot2::theme(legend.position = "bottom",
        legend.justification = "center")

combined_plot




```

```{r}
#| label: fig-7
#| fig-cap: "image caption"

#knitr::include_graphics("imgs/Daubenya_namaquensis.png")
```

Further analysis and main findings can be found on the [Assessment Summary Statistics page](assessment-summary-statistics.html)

## Monitoring

add text

## Species recovery

::: {#box-3 .callout-note .species title="Box 3. Species box" collapse="true"}
## Box 3. Title

Add text

remove the syntax "<!-- -->" for inserting the images replace existing with appropriate images for current page <!--![](imgs/image%20(3).png){fig-alt="box_3_fig_1" width="45%"} ![](imgs/image.jpg){fig-alt="box_3_fig_2" width="45%"}-->

![](imgs/Recovery_work.jpeg)
:::

## Knowledge gaps

add text

## References

::: {#refs}
[@SANBI]
:::
