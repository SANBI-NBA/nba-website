---
# indentations are critical in YAML headers, be careful when editing this section

title: "Sparids" # Compulsory
subtitle: "" # Optional: delete if you are not using a subtitle

title-block-banner: "#De2104" #Background colour of the title block: Apply component colours where necessary - find hex codes in _brand.yml
title-block-banner-color: white # Header text colour: DO NOT CHANGE

# List authors here in the order you want them displayed in the title block
# See examples in README
author:
  # Copy this block and add details for each author of your page. Make sure you maintain indentations exactly as they are here
  - name:
      given: First #Add author's first name here. Abbreviate the middle name
      family: Author #Add author's surname here
    orcid: 0000-0000-0000-0000 # Author's orcid ID. Delete this line if author is not on orcid
    affiliations:
      - ref: af1 # Ref here must match the id of one of the affiliations listed below
      # If an author has more than one affiliation, add more - ref: lines here

affiliations:
# List affiliations here and number them in the order that they are associated with the list of authors above. If multiple authors have the same affiliation, only list the affiliation once here.
# Write out institutional names in full
# See README for common examples - they can be copied and pasted here
# Make sure you maintain indentations exactly as they are here
  - id: af1 # Use this as the affiliation ref with authors above
    number: 1 # This number is used to associate authors with affiliations
    name: Name of Affiliation

# This date determines the PUBLISHED date in the title block
date: last-modified

# Remember to rename the default .bib file and change the name here
bibliography: species.bib

# This section sets up the page citation format. DO NOT EDIT
citation:
  type: webpage
  container-title: National Biodiversity Assessment 2025
  publisher: South African National Biodiversity Institute
  url: http://nba.sanbi.org.za/
# Do not edit or change any of the following entries
appendix-cite-as: false
google-scholar: true
---

------------------------------------------------------------------------

::::::: columns
::: {.column width="25%"}
<center>

| [00%]{.inline-style-threatened}
| taxa assessed
| [Threatened]{.inline-style-indicator}

</center>
:::

::: {.column width="25%"}
<center>

| [00%]{.inline-style-well-protected}
| taxa assessed
| [Well Protected]{.inline-style-indicator}

</center>
:::

::: {.column width="25%"}
<center>

| [00%]{.inline-style-not-protected}
| taxa assessed
| [Not protected]{.inline-style-indicator}

</center>
:::

::: {.column width="25%"}
```{r}
#| label: fig-0
#| fig-cap: "*add image*"
#knitr::include_graphics("")
```
:::
:::::::

------------------------------------------------------------------------

## Key findings

::::: columns
::: {.column width="50%"}
-   

-   

-   
:::

::: {.column width="50%"}
```{r}
#| label: fig-1
#| fig-cap: "Species richness map..."
#knitr::include_graphics("")
```
:::
:::::

### Threat status, trends and pressures

1.  ***Threat status***

add text

:::: panel-tabset
## Figure

<!-- it is important to use second-level headings in panel tabsets, i.e. two hashes -->

```{r}
#| label: fig-2
#| fig-cap: "Threat status of South African ... " 
#| out-width: 100%
#| out-height: "auto"

library(dplyr)
library(tidyr)
library(nbaR)
library(readxl)
library(patchwork)
library(ggplot2)
library(grid)

# ---- Dataset ----

df <- read_excel("./data/overall_status_summary_2025.xlsx",
                 sheet = "Summary")


# ---- Recode Status ----
df <- df %>%
  mutate(Status = recode(Status,
                         "CR" = "Critically Endangered",
                         "CR (PE)" = "Critically Endangered (Possibly Extinct)",
                         "EN" = "Endangered",
                         "VU" = "Vulnerable",
                         "NT" = "Near Threatened",
                         "DD" = "Data Deficient",
                         "LC" = "Least Concern",
                         "EW" = "Extinct in the Wild",
                         "EX" = "Extinct",
                         "Rare" = "Rare"
  ))


# ---- Functions ----

# Collapse rare categories into "Rare"
collapse_rare <- function(df) {
  df %>%
    filter(!Status %in% c("NA", "NE")) %>%
    mutate(Status = ifelse(Status %in% c("Rare", "Critically Rare", "Extremely Rare"),
                           "Rare", Status))
}

# Convert to wide with consistent threat columns
make_wide <- function(df, type, all_levels) {
  df_wide <- df %>%
    group_by(`Taxonomic grouping`, Status) %>%
    summarise(Count = n(), .groups = "drop") %>%
    filter(Status %in% all_levels) %>%
    tidyr::pivot_wider(
      names_from = Status,
      values_from = Count,
      values_fill = 0
    )
  
  # add missing threat columns with zeros
  missing <- setdiff(all_levels, names(df_wide))
  for (m in missing) df_wide[[m]] <- 0
  
  df_wide %>%
    mutate(Type = type) %>%
    select(Type, everything(), all_of(all_levels))
}

# Add total number to donut hole
add_total <- function(plot, total, SCALE_TEXT = 1) {
  plot + annotate("text",
                  x = 2, y = 0,
                  label = total,
                  size = 3.5 * SCALE_TEXT,
                  fontface = "bold")
}

# ---- Setup ----
status_levels <- c(
  "Extinct",
  "Extinct in the Wild",
  "Regionally Extinct",
  "Critically Endangered (Possibly Extinct)",
  "Critically Endangered",
  "Endangered",
  "Vulnerable",
  "Near Threatened",
  "Data Deficient",
  "Rare",
  "Least Concern"
)

all_levels <- status_levels

# ---- sparids ----
df_sparids <- df %>%
  filter(`Taxonomic grouping` == "Sparids") %>%
  collapse_rare() %>%
  mutate(Status = factor(Status, levels = status_levels))

df_sparids_en <- df %>%
  filter(`Taxonomic grouping` == "Sparids", Endemism == "Endemic") %>%
  collapse_rare() %>%
  mutate(Status = factor(Status, levels = status_levels))

df_sparids_wide    <- make_wide(df_sparids, "Overall", all_levels)
df_sparids_en_wide <- make_wide(df_sparids_en, "Endemic", all_levels)

df_combined <- bind_rows(df_sparids_wide, df_sparids_en_wide)

# Identify which threat categories actually have data
available_levels <- df_combined %>%
  select(all_of(all_levels)) %>%
  summarise(across(everything(), sum)) %>%
  pivot_longer(everything(), names_to = "Status", values_to = "Total") %>%
  filter(Total > 0) %>%
  pull(Status)

dat1 <- filter(df_combined, Type == "Overall")
dat2 <- filter(df_combined, Type == "Endemic")
# Filter columns and update status levels
dat1 <- dat1 %>% select(Type, all_of(available_levels))
dat2 <- dat2 %>% select(Type, all_of(available_levels))


overall <- dat1 %>% select(all_of(available_levels)) %>% rowSums()
endemic <- dat2 %>% select(all_of(available_levels)) %>% rowSums()


# ---- Plots ----
plot1 <- nba_plot(dat1, biome, 2:(ncol(dat1)),
                  CHRT = "donut", NUM = FALSE, LAB = "A.") %>%
  add_total(overall)

plot2 <- (nba_plot(dat2, biome, 2:(ncol(dat2)),
                   CHRT = "donut", NUM = FALSE, LAB = "B.") +
            xlim(c(2, 4.5))) %>% add_total(endemic)


# ---- specify legend order ----

my_fill_scale <- scale_fill_manual(
  values = NBA_colours[available_levels],
  breaks = available_levels,
  guide = guide_legend(ncol = 4),
  drop = FALSE
)

plot1 <- plot1 + my_fill_scale
plot2 <- plot2 + my_fill_scale


# ---- Combine with one legend ----
combined_donut_plot <- (plot1 | plot2) +
  plot_layout(guides = "collect") &
  theme(legend.position = "bottom",
        legend.justification = "center")

combined_donut_plot

```

## Data

<!--# If the table is long use the div to give it a vertical scroll bar. Otherwise the div can be excluded. -->

::: {#table .table style="height:500px;overflow-y: auto"}
```{r}
#| label: tbl-tab-0
#| tbl-cap: "Plant threat status." 
#| classes: plain

library(gt)

# First, select only the columns we want and rename Type → Taxon
dat1_sel <- dat1 %>% select(1, 2:ncol(dat1)) %>% rename(Taxon = Type)
dat2_sel <- dat2 %>% select(1, 2:ncol(dat2)) %>% rename(Taxon = Type)

# Now assign custom row names (or first column values)
dat1_sel$Taxon <- "Overall spiders"
dat2_sel$Taxon <- "Endemic spiders"

# Combine into one table
dat_combined_final <- bind_rows(dat1_sel, dat2_sel)

dat_combined_final <- dat_combined_final %>%
  rowwise() %>%
  mutate(Total = sum(c_across(2:ncol(dat_combined_final)), na.rm = TRUE)) %>%
  ungroup() %>%
  select(Taxon, all_of(available_levels), Total)

gt(dat_combined_final) %>% 
  nba_tbl_theme() %>%
  tab_options(table.width = pct(100),
              data_row.padding = px(12)) %>%
  
  tab_style(style = cell_fill(color = "gray90"),
            locations = cells_column_labels(columns = everything())) %>%
  
  cols_width(Taxon ~ pct(15),
             everything() ~ pct(10))
```
:::
::::

2.  ***Trends (RLI)***

add text

```{r}
#| label: fig-3
#| fig-cap: "The Red List Index (RLI) for ..."

library(tidyverse)
library(nbaR)
# --- Dataset ---

df_rlis <- readxl::read_excel("./data/nba_example_RLI_data_trim.xlsx")

df_sparids <- df_rlis%>%
  filter(Taxon %in% c("Sparids", "Aggregate"))

nba_index_plot(
  TYPE = "RLIs",
  DF = df_sparids,
  YEAR = Year,
  RLI = RLI,
  ASSESSMENT_YEAR = Assessment_Year,
  GROUP = Taxon,
  PALETTE = "taxon",
  # AGGREGATE = TRUE,
  SAVE = NULL
)
```

```{r}
#| label: fig-4
#| fig-cap: "The distribution of ... "

#knitr::include_graphics("imgs/Plant_heatmap.png")
```

::: {#box-1 .callout-note .species title="Box 1. Species box" collapse="true"}
## Box 1. Title

add text

remove the syntax "<!-- -->" for inserting the images replace existing with appropriate images for current page <!-- ![](imgs/Fig%201.png){fig-alt="box_1_fig_1" width="45%"}--> <!-- ![](imgs/Figure%202.png){fig-alt="box_1_fig_2" width="45%"}-->
:::

3.  ***Pressures***

add text

```{r}
#| label: fig-5
#| fig-cap: "Key pressures on South Africa’s ... "
#| out.width: 100%


library(stringr)

df <- readxl::read_excel("./data/combined_threat_summary.xlsx", 
                         sheet = "Overall_Maj")


p <- nba_pressure_bar_plot(df, TAXON = "Sparids")
p + scale_x_discrete(
  labels = function(x) {
    sapply(x, function(lbl) {
      wrapped <- str_wrap(lbl, width = 20)  # wrap at ~30 characters
      lines <- unlist(strsplit(wrapped, "\n"))
      paste(head(lines, 3), collapse = "\n")  # max 3 lines
    })
  }
)
```

:::::: {#box-2 .callout-note .species title="Box 2. Species box" collapse="true"}
## Box 2. Title

::::: columns
::: {.column width="100%"}
Add text

remove the syntax "<!-- -->" for inserting the images replace existing with appropriate images for current page <!--![](imgs/Euphorbias%20received.jpg){fig-alt="box_2_fig_2" width="45%"} ![](imgs/fd44b009-60e2.png){fig-alt="box_2_fig_1" width="45%"}

![](imgs/1000067813.png){fig-alt="box_2_fig_1" width="45%"} ![](imgs/20221203_074211.png){fig-alt="box_2_fig_1" width="45%"} -->
:::

::: {.column width="25%"}
:::
:::::
::::::

## Protection level

### Main findings

Add text

```{r}
#| label: fig-6
#| fig-cap: "" 

library(dplyr)
library(tidyr)
library(nbaR)
library(readxl)
library(patchwork)





```

```{r}
#| label: fig-7
#| fig-cap: "image caption"

#knitr::include_graphics("imgs/Daubenya_namaquensis.png")
```

## Monitoring

add text

## Species recovery

::: {#box-3 .callout-note .species title="Box 3. Species box" collapse="true"}
## Box 3. Title

Add text

remove the syntax "<!-- -->" for inserting the images replace existing with appropriate images for current page <!--![](imgs/image%20(3).png){fig-alt="box_3_fig_1" width="45%"} ![](imgs/image.png){fig-alt="box_3_fig_2" width="45%"}-->

![](imgs/Recovery_work.png)
:::

## Knowledge gaps

add text

### Recommended citation

```{r}
#| output: asis
#| label: lst-citation-code

library(nbaR) 
library(knitr)
library(rmarkdown)

# Code for fetching the yaml metadata
# Note that this only runs when the .qmd file is rendered, therefore the outputs of this code block will return no results if you try to run it within R - that does not mean it is not working

meta <- knitr::opts_knit$get("rmarkdown.pandoc.to")  # forces knitr to load metadata
meta <- rmarkdown::metadata  # full YAML is now in `meta`

nba_citation(meta)

```

## References

::: {#refs}
[@SANBI]
:::
